{% extends "admin/base.html" %} {% block title %}Add Patient{% endblock %} {%
block content %}

<div class="bg-card p-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <h4 class="text-md">Add New Patient</h4>
  <p class="text-muted text-sm">Register patient for home / hospital care</p>
</div>

<div class="bg-card p-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <!-- ================= BASIC DETAILS ================= -->
  <h5 class="mb-3 text-md font-semibold underline">Basic Details:</h5>
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <label class="form-label">Service Start Date</label>
      <input id="service_start" type="date" class="form-control" />
    </div>

    <div class="col-md-4">
      <label class="form-label">Service End Date</label>
      <input id="service_end" type="date" class="form-control" />
    </div>

    <div class="col-md-4">
      <label class="form-label">Patient Name</label>
      <input id="name" class="form-control" placeholder="Full name" />
    </div>

    <div class="col-md-4">
      <label class="form-label">Primary Phone</label>
      <input id="phone" class="form-control" placeholder="10 digit mobile" />
    </div>

    <div class="col-md-4">
      <label class="form-label">Emergency Number</label>
      <input id="other_number" class="form-control" />
    </div>

    <div class="col-md-4">
      <label class="form-label">Email</label>
      <input id="email" class="form-control" />
    </div>
  </div>

  <!-- ================= PERSONAL DETAILS ================= -->
  <h5 class="mb-3 text-md font-semibold underline">Personal Details:</h5>
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">Age</label>
      <input id="age" type="number" class="form-control" />
    </div>

    <div class="col-md-3">
      <label class="form-label">Gender</label>
      <select id="gender" class="form-select">
        <option value="">Select</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Medical History</label>
      <textarea id="medical_history" class="form-control"></textarea>
    </div>

    <!-- ================= PATIENT DOCUMENTS ================= -->
    <h5 class="mb-3 text-md font-semibold underline">Patient Documents:</h5>

    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <label class="form-label">Upload Documents (PDF / Image)</label>
        <input
          id="documents"
          type="file"
          class="form-control"
          multiple
          accept=".pdf,.jpg,.jpeg,.png"
        />
      </div>

      <div class="col-md-6">
        <label class="form-label">Uploaded Files</label>
        <ul id="uploadedDocs" class="text-sm text-muted"></ul>
      </div>
    </div>

    <!-- ================= ADDRESS ================= -->
    <div class="col-md-12">
      <label class="form-label">Address</label>
      <textarea
        id="address"
        class="form-control"
        rows="2"
        placeholder="Full home / hospital address"
      ></textarea>
    </div>
  </div>

  <!-- ================= SERVICE DETAILS ================= -->
  <h5 class="mb-3 text-md font-semibold underline">Service Details:</h5>
  <div class="row g-3 mb-4">
    <!-- Hospital -->
    <div class="col-md-4">
      <label class="form-label">Hospital</label>
      <select id="hospital" class="form-select">
        <option value="">Select Hospital</option>
        {% for h in hospitals %}
        <option value="{{ h.id }}">{{ h.name }} ({{ h.branch }})</option>
        {% endfor %}
      </select>
    </div>

    <!-- Doctor -->
    <div class="col-md-4">
      <label class="form-label">Assign Doctor</label>
      <select id="doctor" class="form-select">
        <option value="">Not Assigned</option>
        {% for doc in doctors %}
        <option value="{{ doc.id }}">
          {{ doc.user.name }} ({{ doc.specialization }})
        </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- ================= ACTION ================= -->
  <div class="text-end">
    <button
      type="button"
      class="btn bg-green-600 text-white hover:bg-green-700 px-4"
      onclick="createPatient()"
    >
      Save Patient
    </button>
  </div>
</div>

<!-- ================= GLOBAL API ================= -->
<script>
  /* ================= AUTH & GUARD ================= */
  function headers() {
    return {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.getItem("token"),
    };
  }

  function guard() {
    if (!localStorage.getItem("token")) {
      window.location.href = "/admin/login";
    }
  }

  guard();

  /* ================= DOCUMENT UPLOAD ================= */
  let uploadedDocuments = [];

  document.addEventListener("DOMContentLoaded", () => {
    const docInput = document.getElementById("documents");
    if (!docInput) return;

    docInput.addEventListener("change", async function (e) {
      const files = e.target.files;
      if (!files.length) return;

      for (let file of files) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("folder", "documents");

        try {
          const res = await fetch("/upload/file", {
            method: "POST",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            body: formData,
          });

          const data = await res.json();

          if (res.ok && data.success) {
            uploadedDocuments.push(data.path);

            const li = document.createElement("li");
            li.className = "flex justify-between items-center";

            li.innerHTML = `
              <span>${data.path.split("/").pop()}</span>
              <button class="btn btn-sm btn-danger ms-2">âœ•</button>
            `;

            // âŒ remove document
            li.querySelector("button").onclick = () => {
              uploadedDocuments = uploadedDocuments.filter(
                (p) => p !== data.path,
              );
              li.remove();
            };

            document.getElementById("uploadedDocs").appendChild(li);
          } else {
            alert("File upload failed");
          }
        } catch (err) {
          console.error("Upload error:", err);
          alert("Document upload failed");
        }
      }

      // reset input so same file can be uploaded again if needed
      e.target.value = "";
    });
  });

  /* ================= CREATE PATIENT ================= */
  async function createPatient() {
    const payload = {
      name: document.getElementById("name").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      other_number:
        document.getElementById("other_number").value.trim() || null,
      email: document.getElementById("email").value.trim() || null,
      age: document.getElementById("age").value || null,
      gender: document.getElementById("gender").value || null,
      medical_history: document.getElementById("medical_history").value || null,
      address: document.getElementById("address").value.trim() || null,
      service_start: document.getElementById("service_start").value || null,
      service_end: document.getElementById("service_end").value || null,
      hospital: document.getElementById("hospital").value || null,
      assigned_doctor: document.getElementById("doctor").value || null,

      // ðŸ”¥ documents
      documents: uploadedDocuments,
    };

    console.log("ðŸ“¦ Payload:", payload);

    if (!payload.name || !payload.phone) {
      alert("Name and phone are required");
      return;
    }

    try {
      const res = await fetch("/patient/create", {
        method: "POST",
        headers: headers(),
        body: JSON.stringify(payload),
      });

      const data = await res.json();

      if (res.ok && data.success) {
        alert("âœ… Patient added successfully!");
        window.location.href = "/admin/patients";
      } else {
        alert(data.detail || "Failed to add patient");
      }
    } catch (err) {
      console.error("Create patient error:", err);
      alert("Something went wrong");
    }
  }
</script>

{% endblock %}
