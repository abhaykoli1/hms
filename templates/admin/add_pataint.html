{% extends "admin/base.html" %}
{% block title %}Create Patient{% endblock %}
{% block content %}

<div class="card p-3 mb-4">
  <h4>Create Patient</h4>
  <p class="text-muted">Patient registration</p>
</div>

<form id="patientForm" class="card p-4">

  <!-- hidden -->
  <input type="hidden" id="documents" />

  <h5 class="mb-3">Basic Details</h5>
  <div class="row">

    <div class="col-md-4 mb-3">
      <label>Name *</label>
      <input class="form-control" id="name" required />
    </div>

    <div class="col-md-4 mb-3">
      <label>Father Name</label>
      <input class="form-control" id="father_name" />
    </div>

    <div class="col-md-4 mb-3">
      <label>Phone *</label>
      <input class="form-control" id="phone" required />
    </div>

    <div class="col-md-4 mb-3">
      <label>Emergency Phone</label>
      <input class="form-control" id="other_number" />
    </div>

    <div class="col-md-4 mb-3">
      <label>Email</label>
      <input class="form-control" id="email" />
    </div>

    <div class="col-md-4 mb-3">
      <label>Age</label>
      <input type="number" class="form-control" id="age" />
    </div>

    <div class="col-md-4 mb-3">
      <label>Gender</label>
      <select class="form-control" id="gender">
        <option value="">Select</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>
    </div>

    <div class="col-md-4 mb-3">
      <label>Hospital</label>
      <select class="form-control" id="hospital">
        <option value="">Select Hospital</option>
        {% for h in hospitals %}
        <option value="{{ h.id }}">{{ h.name }} ({{ h.branch }})</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4 mb-3">
      <label>Service Start</label>
      <input type="date" class="form-control" id="service_start" />
    </div>

    <div class="col-md-4 mb-3">
      <label>Service End</label>
      <input type="date" class="form-control" id="service_end" />
    </div>

    <div class="col-md-12 mb-3">
      <label>Address</label>
      <textarea class="form-control" id="address"></textarea>
    </div>

    <div class="col-md-12 mb-3">
      <label>Medical History</label>
      <textarea class="form-control" id="medical_history"></textarea>
    </div>

    <div class="col-md-6 mb-3">
      <label>Documents</label>
      <input
        type="file"
        multiple
        class="form-control"
        onchange="uploadMultipleFiles(this)"
      />
    </div>

    <div class="col-md-6 mb-3">
      <label>Assign Doctor</label>
      <select class="form-control" id="assigned_doctor">
        <option value="">Not Assigned</option>
        {% for d in doctors %}
        <option value="{{ d.id }}">
          Dr. {{ d.user.name }} ({{ d.specialization }})
        </option>
        {% endfor %}
      </select>
    </div>

  </div>

  <div class="text-end">
    <button class="btn btn-success px-4">Create Patient</button>
  </div>
</form>

<script>
const FILE_API = "/upload/file";
const CREATE_API = "/patient/create";

/* ---------- FILE UPLOAD ---------- */
async function uploadMultipleFiles(input) {
  const paths = [];
  for (const file of input.files) {
    const fd = new FormData();
    fd.append("file", file);
    fd.append("folder", "documents");

    const res = await fetch(FILE_API, {
      method: "POST",
      headers: { Authorization: headers().Authorization },
      body: fd
    });

    const data = await res.json();
    if (res.ok) paths.push(data.path);
  }
  document.getElementById("documents").value = JSON.stringify(paths);
}

/* ---------- SUBMIT ---------- */
document.getElementById("patientForm").onsubmit = async (e) => {
  e.preventDefault();

  const payload = {
    name: document.getElementById("name").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    father_name: document.getElementById("father_name").value || null,
    other_number: document.getElementById("other_number").value || null,
    email: document.getElementById("email").value || null,
    age: document.getElementById("age").value || null,
    gender: document.getElementById("gender").value || null,
    address: document.getElementById("address").value || null,
    medical_history: document.getElementById("medical_history").value || null,
    service_start: document.getElementById("service_start").value || null,
    service_end: document.getElementById("service_end").value || null,
    hospital: document.getElementById("hospital").value || null,
    assigned_doctor: document.getElementById("assigned_doctor").value || null,
    documents: document.getElementById("documents").value
      ? JSON.parse(document.getElementById("documents").value)
      : []
  };

  console.log("ðŸ“¦ PAYLOAD:", payload);

  const res = await fetch(CREATE_API, {
    method: "POST",
    headers: headers(),
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  if (res.ok) {
    alert("Patient created successfully");
    window.location.href = "/admin/patients";
  } else {
    alert(data.detail || "Error creating patient");
  }
};
</script>

{% endblock %}
