{% extends "admin/base.html" %} {% block title %}Notifications{% endblock %} {%
block content %}

<div class="bg-card rounded-2xl shadow-soft p-6 max-w-4xl">
  <h2 class="text-xl font-bold mb-4">ðŸ”” Send Push Notification</h2>

  <!-- ROLE SELECT -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <label class="form-label">Role</label>
      <select id="roleSelect" class="form-select">
        <option value="ALL">All Users</option>
        <option value="NURSE">Nurse</option>
        <option value="DOCTOR">Doctor</option>
        <option value="PATIENT">Patient</option>
        <option value="STAFF">Staff</option>
      </select>
    </div>

    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-primary w-100" onclick="loadUsers()">
        Load Users
      </button>
    </div>
  </div>

  <!-- USERS LIST -->
  <div
    class="border rounded-3 p-3 mb-4"
    style="max-height: 280px; overflow: auto"
  >
    <div class="d-flex justify-content-between mb-2">
      <strong>Users</strong>
      <button class="btn btn-sm btn-outline-secondary" onclick="selectAll()">
        Select All
      </button>
    </div>

    <div id="usersBox"></div>
  </div>

  <!-- TITLE -->
  <div class="mb-3">
    <label class="form-label">Title</label>
    <input id="title" class="form-control" placeholder="Notification title" />
  </div>

  <!-- BODY -->
  <div class="mb-3">
    <label class="form-label">Message</label>
    <textarea id="body" class="form-control" rows="3"></textarea>
  </div>

  <!-- SEND BUTTON -->
  <button class="btn btn-success" onclick="sendNotification()">
    ðŸš€ Send Notification
  </button>
</div>

{% endblock %} {% block scripts %}

<script>
  let selectedUsers = [];

  // âœ… load users by role
  async function loadUsers() {
    selectedUsers = [];

    const role = document.getElementById("roleSelect").value;

    const res = await fetch(`/admin/users-notification?role=${role}`);
    const users = await res.json();

    const box = document.getElementById("usersBox");
    box.innerHTML = "";

    users.forEach((u) => {
      box.innerHTML += `
      <div class="form-check mb-1">
        <input class="form-check-input"
          type="checkbox"
          value="${u.id}"
          onchange="toggleUser(this)">
        <label class="form-check-label">
          ${u.name || "No Name"} (${u.phone}) - ${u.role}
        </label>
      </div>
    `;
    });
  }

  // âœ… toggle user
  function toggleUser(el) {
    if (el.checked) {
      selectedUsers.push(el.value);
    } else {
      selectedUsers = selectedUsers.filter((id) => id !== el.value);
    }
  }

  // âœ… select all
  function selectAll() {
    document.querySelectorAll("#usersBox input").forEach((c) => {
      c.checked = true;
      if (!selectedUsers.includes(c.value)) {
        selectedUsers.push(c.value);
      }
    });
  }

  // âœ… send notification
  async function sendNotification() {
    const title = document.getElementById("title").value;
    const body = document.getElementById("body").value;
    const role = document.getElementById("roleSelect").value;

    if (!title || !body) {
      alert("Title & body required");
      return;
    }

    await fetch("/admin/send-notification", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title,
        body,
        role,
        user_ids: selectedUsers.length ? selectedUsers : null,
        send_all: selectedUsers.length === 0,
      }),
    });

    alert("âœ… Notification sent successfully");
  }
</script>

{% endblock %}
