{% extends "admin/base.html" %}
{% block title %}Patient Details{% endblock %}

{% block content %}
<script>
  guard();
</script>

<h4 class="mb-4">üßë‚Äç‚öïÔ∏è Patient Details</h4>

<!-- ================= TABS ================= -->
<div class="mb-4 border-b border-gray-200">
  <nav class="flex gap-6 text-sm font-medium">
    <button
      id="tab-details-btn"
      onclick="openTab('details')"
      class="tab-btn border-b-2 border-primary text-primary pb-2"
    >
      üßë‚Äç‚öïÔ∏è Details
    </button>

    <button
      id="tab-billing-btn"
      onclick="openTab('billing')"
      class="tab-btn border-b-2 border-transparent text-gray-500 pb-2 hover:text-primary"
    >
      üí∞ Billing
    </button>
  </nav>
</div>


<!-- <div class="tab-content"> -->

<!-- ========================================================= -->
<!-- ================= DETAILS TAB =========================== -->
<!-- ========================================================= -->
<!-- <div class="tab-pane fade show active" id="tab-details"> -->
<div id="tab-details" class="tab-content">


<!-- ================= PATIENT BASIC INFO ================= -->
<div class="bg-card  mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="card-header p-2 px-3 !rounded-t-2xl   bg-light">
    <b>üë§ Basic Information</b>
  </div>
  <div class="card-body p-3">
    <div class="row">
      <div class="col-md-4">
        <p><b>Name:</b> {{ patient.user.name }}</p>
        <p><b>Phone:</b> {{ patient.user.phone }}</p>
        <p><b>Email:</b> {{ patient.user.email or "-" }}</p>
        
      </div>
      <div class="col-md-4">
        <p><b>Age:</b> {{ patient.age }}</p>
        <p><b>Gender:</b> {{ patient.gender }}</p>
        <p><b>Address:</b> {{ patient.address }}</p>
       
      </div>
      <div class="col-md-4">
        <p><b>Service Start:</b> {{ patient.service_start }}</p>
        <p><b>Service End:</b> {{ patient.service_end if patient.service_end else "‚Äî" }}</p>
        <p>
          <b>Assigned Doctor:</b>
          {% if doctor %}
            Dr. {{ doctor.user.name }} ({{ doctor.specialization }})
          {% else %}
            <span class="text-muted">Not Assigned</span>
          {% endif %}
        </p>
      </div>
    </div>
     <p><b>Documents:</b></p>

    {% if patient.documents %}
      <ul class="list-unstyled mt-2">
        {% for doc in patient.documents %}
          <li class="mb-1">
            <a href="{{ doc }}" target="_blank" class="text-primary">
              üìÑ Document {{ loop.index }}
            </a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <span class="text-muted">No documents uploaded</span>
    {% endif %}
  </div>
</div>

<!-- ================= NURSE VISITS ================= -->
<div class="bg-card  mb-3  border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="card-header p-2 px-3 !rounded-t-2xl   bg-light">
    <b>üë©‚Äç‚öïÔ∏è Nurse Visits</b>
  </div>
  <div class="card-body">
    {% if duties %}
    <table class="table table-sm table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Nurse</th>
          <th>Nurse Type</th>
          <th>Duty Type</th>
          <th>Shift</th>
          <th>Start</th>
          <th>End</th>
        </tr>
      </thead>
      <tbody>
        {% for duty in duties %}
        <tr>
          <td>{{ duty.nurse.user.name }}</td>
          <td>{{ duty.nurse.nurse_type }}</td>
          <td>{{ duty.duty_type }}</td>
          <td>{{ duty.shift }}</td>
          <td>{{ duty.duty_start.strftime("%d %b %Y %H:%M") }}</td>
          <td>{{ duty.duty_end.strftime("%d %b %Y %H:%M") }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted p-3">No nurse visits recorded.</p>
    {% endif %}
  </div>
</div>

<!-- ================= DAILY NOTES ================= -->
<div class="bg-card  mb-3  border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="card-header p-2 px-3 !rounded-t-2xl   bg-light">
    <b>üìù Daily Nursing Notes</b>
  </div>
  <div class="card-body">
    {% if notes %}
    <table class="table table-sm table-bordered">
      <thead class="table-light">
        <tr>
          <th>Nurse</th>
          <th>Note</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody>
        {% for n in notes %}
        <tr>
          <td>{{ n.nurse.user.name }}</td>
          <td>{{ n.note }}</td>
          <td>{{ n.created_at.strftime("%d %b %Y %H:%M") }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted p-3">No notes available.</p>
    {% endif %}
  </div>
</div>

<!-- ================= VITALS ================= -->
<div class="bg-card mb-4 border border-gray-50/20 rounded-2xl shadow-soft4">

  <!-- HEADER -->
  <div class="p-3 rounded-t-2xl bg-light flex justify-between items-center">
    <h6 class="mb-0 font-semibold">‚ù§Ô∏è Patient Vitals</h6>
    <span class="text-xs text-gray-500">
      Total: {{ vitals|length }}
    </span>
  </div>

  <div class="p-3">

    {% if vitals %}

    <div class="space-y-4">

      {% for v in vitals %}

      <!-- ================= SINGLE VITAL CARD ================= -->
      <div class="border rounded-xl p-3 shadow-sm bg-white">

        <!-- TIME -->
        <div class="text-sm text-muted mb-3 fw-semibold">
          {{ v.recorded_at.strftime("%d %b %Y ‚Ä¢ %H:%M") }}
        </div>


        <!-- ================= BASIC VITALS ================= -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-3">

          <div class="p-2 rounded bg-gray-50 text-center">
            <div class="text-xs text-gray-500">BP</div>
            <div class="fw-bold">{{ v.bp or "-" }}</div>
          </div>

          <div class="p-2 rounded bg-gray-50 text-center">
            <div class="text-xs text-gray-500">Pulse</div>
            <div class="fw-bold text-success">{{ v.pulse or "-" }}</div>
          </div>

          <div class="p-2 rounded bg-gray-50 text-center">
            <div class="text-xs text-gray-500">SpO‚ÇÇ</div>
            <div class="fw-bold text-primary">{{ v.spo2 or "-" }}</div>
          </div>

          <div class="p-2 rounded bg-gray-50 text-center">
            <div class="text-xs text-gray-500">Temp</div>
            <div class="fw-bold">{{ v.temperature or "-" }}</div>
          </div>

          <div class="p-2 rounded bg-gray-50 text-center">
            <div class="text-xs text-gray-500">O‚ÇÇ Level</div>
            <div class="fw-bold">{{ v.o2_level or "-" }}</div>
          </div>

          <div class="p-2 rounded bg-gray-50 text-center">
            <div class="text-xs text-gray-500">RBS</div>
            <div class="fw-bold">{{ v.rbs or "-" }}</div>
          </div>

        </div>


        <!-- ================= SUPPORT / DEVICES ================= -->
        <div class="mb-3">
          <div class="text-xs text-gray-500 mb-1 fw-semibold">Support / Devices</div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">

            <div>BiPAP: <b>{{ v.bipap_ventilator or "-" }}</b></div>
            <div>IV Fluids: <b>{{ v.iv_fluids or "-" }}</b></div>
            <div>Suction: <b>{{ v.suction or "-" }}</b></div>
            <div>Feeding: <b>{{ v.feeding_tube or "-" }}</b></div>

          </div>
        </div>


        <!-- ================= OUTPUTS ================= -->
        <div class="mb-3">
          <div class="text-xs text-gray-500 mb-1 fw-semibold">Outputs</div>

          <div class="grid grid-cols-3 gap-3">

            <div>Vomit: <b>{{ v.vomit_aspirate or "-" }}</b></div>
            <div>Urine: <b>{{ v.urine or "-" }}</b></div>
            <div>Stool: <b>{{ v.stool or "-" }}</b></div>

          </div>
        </div>


        <!-- ================= NOTES ================= -->
        {% if v.other %}
        <div class="text-sm text-gray-600 border-top pt-2">
          <b>Notes:</b> {{ v.other }}
        </div>
        {% endif %}

      </div>
      <!-- ================= END CARD ================= -->


      {% endfor %}

    </div>

    {% else %}
      <p class="text-muted text-center py-4">No vitals recorded</p>
    {% endif %}

  </div>
</div>

<!-- ================= MEDICATIONS ================= -->
<div class="bg-card  mb-3  border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="card-header p-2 px-3 !rounded-t-2xl   bg-light">
    <b>üíä Prescribed Medications</b>
  </div>
  <div class="card-body">
    {% if medications %}
    <table class="table table-sm table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Medicine</th>
          <th>Dosage</th>
          <th>Timing</th>
          <th>Duration</th>
          <th>Price</th>
        </tr>
      </thead>
      <tbody>
        {% for m in medications %}
        <tr>
          <td>{{ m.medicine_name }}</td>
          <td>{{ m.dosage }}</td>
          <td>{{ m.timing | join(", ") }}</td>
          <td>{{ m.duration_days }}</td>
          <td>{% if m.price %}‚Çπ {{ m.price }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted  p-3">No medications prescribed.</p>
    {% endif %}
  </div>
</div>

</div>

<!-- ========================================================= -->
<!-- ================= BILLING TAB =========================== -->
<!-- ========================================================= -->
<!-- <div class="tab-pane fade" id="tab-billing"> -->

  <div id="tab-billing" class="tab-content hidden">


<!-- ================= GENERATE BILL ================= -->
<div class="bg-card  mb-3  border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="card-header p-2 px-3 !rounded-t-2xl   bg-light">
    <b>üßæ Generate Bill</b>
  </div>
  <div class="card-body  p-3">

    <!-- DISCOUNT / EXTRA -->
    <div class="row g-2 mb-3">
      <div class="col-md-3">
        <input id="discount" type="number" class="form-control" placeholder="Discount">
      </div>
      <div class="col-md-3">
        <input id="extra_charges" type="number" class="form-control" placeholder="Extra Charges">
      </div>
    </div>

    <!-- OTHER ITEMS -->
    <h6 class="mt-3">Other Billing Items</h6>

    <table class="table table-sm table-bordered mb-3">
      <!-- <thead class="table-light">
        <tr>
          <th>Title</th>
          <th width="120">Qty</th>
          <th width="150">Unit Price</th>
          <th width="60"></th>
        </tr>
      </thead> -->
      <thead class="table-light">
        <tr>
          <th>Title</th>
          <th width="140">Start Date</th>
          <th width="140">Till Date</th>
          <th width="80">Days</th>
           <th width="120">Qty</th>
            <th width="120">Price</th> <!-- üî• NEW -->
           <th width="60">GST</th>
          <th width="120">Unit Price</th>
          <th width="60"></th>
        </tr>
      </thead>
      <tbody id="otherItemsTable">
        <!-- rows added by JS -->
      </tbody>
    </table>

    <button class="btn btn-sm btn-outline-secondary mb-3" onclick="addOtherItemRow()">
      ‚ûï Add Item
    </button>

    <br>

    <button class="btn btn-sm btn-primary" onclick="generateBill()">
      Generate Bill
    </button>
  </div>
</div>

<!-- ================= BILL LIST ================= -->
<div class="bg-card  mb-3  border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="card-header flex justify-content-between align-items-center  p-2 px-3 !rounded-t-2xl   bg-light">
    <b>üìÑ Bills</b>  <div class="d-flex justify-content-end ">
      <input
        id="gst_download_percent"
        type="number"
        class="form-control form-control-sm"
        value="18"
        style="width:120px"
      />
    </div>
  </div>
  <div class="card-body">
      <!-- üëá ADD HERE -->
   
    <table class="table table-sm table-bordered">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          <th>Amount</th>
          <th>Status</th>
          <th>PDF</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="billTable">
        <tr>
          <td colspan="5" class="text-center text-muted">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

</div>




</div>
</div>

<!-- <script>
document.getElementById("gst_enabled").addEventListener("change", function () {
  document.getElementById("gst_percent").disabled = !this.checked;
});
</script> -->

<script>
  function openTab(tab) {
    // Hide all tab contents
    document.querySelectorAll(".tab-content").forEach(el => {
      el.classList.add("hidden");
    });

    // Reset buttons
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.classList.remove("border-primary", "text-primary");
      btn.classList.add("border-transparent", "text-gray-500");
    });

    // Show selected tab
    document.getElementById(`tab-${tab}`).classList.remove("hidden");

    // Activate button
    const btn = document.getElementById(`tab-${tab}-btn`);
    btn.classList.remove("border-transparent", "text-gray-500");
    btn.classList.add("border-primary", "text-primary");

    // Special case: load bills only when billing opens
    if (tab === "billing") {
      loadBills();
    }
  }
</script>

<script>
const patientId = "{{ patient.id }}";

/* ---------- OTHER ITEMS UI ---------- */

function addOtherItemRow() {
  const tbody = document.getElementById("otherItemsTable");
  const row = document.createElement("tr");

 row.innerHTML = `
    <td>
      <input class="form-control item-title" placeholder="Service name">
    </td>

    <td>
      <input type="date" class="form-control item-start" onchange="calculateDays(this)">
    </td>

    <td>
      <input type="date" class="form-control item-till" onchange="calculateDays(this)">
    </td>

    <td>
      <input type="number" class="form-control item-days" readonly>
    </td>

    <td>
      <input type="number" value="1" min="1"
      class="form-control item-qty"
      onchange="updateRowTotal(this)">
      </td>
      
      
      <td>
        <input type="number"
        class="form-control item-price"
        placeholder="Unit price"
        onchange="updateRowTotal(this)">
        </td>
        <td>
          <select class="form-control item-gst"
            onchange="updateRowTotal(this)">
            <option value="0">0%</option>
            <option value="5">5%</option>
            <option value="12">12%</option>
            <option value="18">18%</option>
          </select>
        </td>

    <!-- üî• FINAL PRICE -->
    <td>
      <input type="number"
        class="form-control item-final-price"
        readonly>
    </td>

    <td>
      <button class="btn btn-sm btn-danger"
        onclick="this.closest('tr').remove()">‚úñ</button>
    </td>
  `;

  tbody.appendChild(row);
}



/* ---------- GENERATE BILL ---------- */

function generateBill() {
  const otherItems = [];

  document.querySelectorAll("#otherItemsTable tr").forEach(row => {
    const title = row.querySelector(".item-title").value.trim();
    const start_date = row.querySelector(".item-start").value;
    const till_date = row.querySelector(".item-till").value;
    const days = Number(row.querySelector(".item-days").value) || null;
    const quantity = Number(row.querySelector(".item-qty").value) || 1;
    const unit_price = Number(row.querySelector(".item-price").value);
    const gst_percent = Number(row.querySelector(".item-gst").value);

    if (title && unit_price > 0) {
      otherItems.push({
        title,
        start_date: start_date || null,
        till_date: till_date || null,
        days,
        quantity,
        unit_price,
         gst_percent   // üî• NEW
      });

     
    }

  });


  const payload = {
    patient_id: patientId,
    discount: Number(document.getElementById("discount").value) || 0,
    extra_charges: Number(document.getElementById("extra_charges").value) || 0,
    other_items: otherItems
  };

  console.log("üì§ Billing payload:", payload);

fetch("/billing/admin/billing/generate", {
  method: "POST",
  headers: headers(),
  body: JSON.stringify(payload)
})
.then(async r => {
  console.log("üì° Response status:", r.status);

  const data = await r.json();
  console.log("üì• Response data:", data);

  if (!r.ok) {
    throw data;
  }

  return data;
})
.then(d => {
  alert(d.message || "Bill generated");
  loadBills();
})
.catch(err => {
  console.error("‚ùå Billing API error:", err);
  alert(err.detail || "Failed to generate bill");
});
}

function calculateDays(el) {
  const row = el.closest("tr");

  const start = row.querySelector(".item-start").value;
  const till = row.querySelector(".item-till").value;
  const daysInput = row.querySelector(".item-days");

  if (start && till) {
    const s = new Date(start);
    const t = new Date(till);

    const days =
      Math.floor((t - s) / (1000 * 60 * 60 * 24)) + 1;

    // daysInput.value = days > 0 ? days : "";
    daysInput.value = days > 0 ? days : "";
    updateRowTotal(row.querySelector(".item-days"));
  } else {
    daysInput.value = "";
  }
}
function resetQty(daysInput, qtyInput) {
  daysInput.value = "";
  qtyInput.readOnly = false;
  qtyInput.value = 1;   // ‚úÖ DEFAULT BACK TO 1
}
/* ---------- LOAD BILLS ---------- */

function loadBills() {
  fetch(`/billing/admin/patient/${patientId}/bills`, {
    headers: headers()
  })
  .then(r => r.json())
  .then(data => {
    const tbody = document.getElementById("billTable");
    tbody.innerHTML = "";

    if (!data.length) {
      tbody.innerHTML =
        `<tr><td colspan="5" class="text-center">No bills</td></tr>`;
      return;
    }

    data.forEach(b => {
      tbody.innerHTML += `
        <tr>
          <td>${b.date}</td>
          <td>‚Çπ ${b.amount}</td>
          <td>${b.status}</td>
          <td>
            <a href="/billing/admin/billing/${b.bill_id}/download"
               target="_blank"
               class="btn btn-sm btn-outline-secondary">
               Non-GST
            </a>
            <a href="/billing/admin/billing/${b.bill_id}/download?gst_percent=18"
               target="_blank"
               class="btn btn-sm btn-outline-success ms-1">
               GST
            </a>
          </td>
          <td>
            ${
              b.status === "UNPAID"
              ? `<button class="btn btn-sm btn-success"
                   onclick="markPaid('${b.bill_id}')">Mark Paid</button>`
              : "-"
            }
          </td>
        </tr>`;
    });
  })
  .catch(err => {
    console.error("Bill load error:", err);
    alert("Failed to load bills");
  });
}

function updateRowTotal(el) {
  const row = el.closest("tr");

  const days = Number(row.querySelector(".item-days").value) || 0;
  const qty = Number(row.querySelector(".item-qty").value) || 1;
  const unit = Number(row.querySelector(".item-price").value) || 0;
  const gst = Number(row.querySelector(".item-gst").value) || 0;

  let base;

  if (days > 0) {
    base = days * qty * unit;
  } else {
    base = qty * unit;
  }

  const gstAmount = base * gst / 100;
  const finalPrice = base + gstAmount;

  row.querySelector(".item-final-price").value =
    finalPrice.toFixed(2);
}


/* ---------- MARK PAID ---------- */
function markPaid(id) {
  fetch(`/billing/admin/billing/mark-paid?bill_id=${id}`, {
    method: "POST",
    headers: headers()
  })
  .then(r => r.json())
  .then(d => {
    alert(d.message);
    loadBills();
  });
}

/* Load bills when Billing tab opens */
// document
//   .querySelector('a[href="#tab-billing"]')
//   .addEventListener("click", loadBills);

// Re-load bills when GST % changes
document
  .getElementById("gst_download_percent")
  ?.addEventListener("input", loadBills);
</script>


{% endblock %}
