{% extends "admin/base.html" %} {% block title %}SOS Alert Full Details{%
endblock %} {% block content %}
<script>
  guard();
</script>

<div class="bg-card p-3 rounded-2xl shadow-soft4 sos mb-4">
  <h4 class="mb-2 text-md font-semibold">ğŸš¨ SOS ALERT â€“ COMPLETE DETAILS</h4>
  <hr class="mt-2" />

  <!-- ================= SOS BASIC ================= -->
  <h5 class="mt-2 text-md font-medium underline">ğŸ”´ SOS Information:</h5>

  <p>
    <b>Status:</b>
    <span
      class="badge {% if sos.status == 'ACTIVE' %}bg-danger{% else %}bg-success{% endif %}"
    >
      {{ sos.status }}
    </span>
  </p>

  <p><b>Message:</b> {{ sos.message or "-" }}</p>
  <p>
    <b>Triggered At:</b>
    {{ sos.created_at.strftime("%d %b %Y %H:%M") if sos.created_at else "-" }}
  </p>

  <hr class="mt-2" />

  <!-- ================= TRIGGERED USER ================= -->
  <h5 class="mt-2 text-md font-medium underline">ğŸ‘¤ Triggered By (User):</h5>

  {% if sos.triggered_by %}
  <p><b>Name:</b> {{ sos.triggered_by.name or "-" }}</p>
  <p><b>Role:</b> {{ sos.triggered_by.role or "-" }}</p>
  <p><b>Phone:</b> {{ sos.triggered_by.phone or "-" }}</p>
  <p><b>Email:</b> {{ sos.triggered_by.email or "-" }}</p>
  {% else %}
  <p class="text-muted">Triggered user not available</p>
  {% endif %}

  <hr class="mt-2" />

  <!-- ================= PATIENT ================= -->
  <h5 class="mt-2 text-md font-medium underline">ğŸ§‘â€ğŸ¦½ Patient Details:</h5>

  {% if patient %}
  <p><b>Name:</b> {{ patient.user.name if patient.user else "-" }}</p>
  <p><b>Age:</b> {{ patient.age }}</p>
  <p><b>Gender:</b> {{ patient.gender }}</p>
  <p><b>Phone:</b> {{ patient.user.phone if patient.user else "-" }}</p>
  <p><b>Medical History:</b> {{ patient.medical_history or "-" }}</p>
  <p><b>Address:</b> {{ patient.address or "-" }}</p>
  <p>
    <b>Service Period:</b>
    {{ patient.service_start or "-" }} â†’ {{ patient.service_end if
    patient.service_end else "Ongoing" }}
  </p>
  {% else %}
  <p class="text-muted">Patient details not available</p>
  {% endif %}

  <hr class="mt-2" />

  <!-- ================= DOCTOR ================= -->
  <h5 class="mt-2 text-md font-medium underline">ğŸ‘¨â€âš•ï¸ Assigned Doctor:</h5>

  {% if doctor and doctor.user %}
  <p><b>Name:</b> {{ doctor.user.name }}</p>
  <p><b>Specialization:</b> {{ doctor.specialization or "-" }}</p>
  <p><b>Registration No:</b> {{ doctor.registration_number or "-" }}</p>
  <p><b>Experience:</b> {{ doctor.experience_years or 0 }} years</p>
  <p><b>Available:</b> {{ "Yes" if doctor.available else "No" }}</p>
  {% else %}
  <p class="text-muted">No doctor assigned</p>
  {% endif %}

  <hr class="mt-2" />

  <!-- ================= NURSE ================= -->
  <h5 class="mt-2 text-md font-medium underline">ğŸ‘©â€âš•ï¸ On-Duty Nurse:</h5>

  {% if nurse %}
  <p><b>Name:</b> {{ nurse_user.name if nurse_user else "-" }}</p>
  <p><b>Phone:</b> {{ nurse_user.phone if nurse_user else "-" }}</p>
  <p><b>Nurse Type:</b> {{ nurse.nurse_type or "-" }}</p>
  <p><b>Aadhaar:</b> {{ nurse.aadhaar_number or "-" }}</p>
  <p><b>Verification:</b> {{ nurse.verification_status or "-" }}</p>
  <p>
    <b>Police Verification:</b> {{ nurse.police_verification_status or "-" }}
  </p>
  {% else %}
  <p class="text-muted">No nurse currently assigned</p>
  {% endif %}

  <hr class="mt-2" />

  <!-- ================= DUTY ================= -->
  {% if duty %}
  <h5 class="mt-2 text-md font-medium underline">â° Active Duty:</h5>
  <p><b>Duty Type:</b> {{ duty.duty_type }}</p>
  <p><b>Shift:</b> {{ duty.shift }}</p>
  <p>
    <b>Duty Start:</b> {{ duty.duty_start.strftime("%d %b %Y %H:%M") if
    duty.duty_start else "-" }}
  </p>
  <p>
    <b>Duty End:</b> {{ duty.duty_end.strftime("%d %b %Y %H:%M") if
    duty.duty_end else "-" }}
  </p>
  {% else %}
  <p class="text-muted">No active duty found</p>
  {% endif %}

  <hr class="mt-2" />

  <!-- ================= ACTION ================= -->
  {% if sos.status == "ACTIVE" %}
  <button class="btn btn-danger mt-3" onclick="resolveSOS('{{ sos.id }}')">
    âœ… Mark as Resolved
  </button>
  {% endif %}
</div>

<script>
  function resolveSOS(sosId) {
    if (!confirm("Resolve this SOS?")) return;

    fetch(`${API}/sos/admin/resolve-admin?sos_id=` + sosId, {
      method: "POST",
      headers: headers(),
    })
      .then((r) => r.json())
      .then((d) => {
        alert(d.message || "SOS resolved");
        location.reload();
      })
      .catch(() => alert("Failed to resolve SOS"));
  }
</script>

{% endblock %}
