{% extends "admin/base.html" %} {% block title %}Equipment Management{% endblock
%} {% block content %}

<div class="space-y-6">
  <!-- ADD CARD -->
  <div class="bg-card border border-gray-50/20 rounded-2xl shadow-soft4">
    <!-- HEADER -->
    <div class="d-flex p-3 justify-content-between align-items-center">
      <h5 class="mb-0 text-md">⚙️ Equipment Management</h5>
      <!-- <div class="d-flex gap-2">
        <button
          class="bg-green-500 text-white px-2 py-1.5 !rounded-xl hover:bg-green-600 transition-colors"
          onclick="window.location.href = '/admin/create/nurse'"
        >
          ➕ Add Nurse
        </button>
      </div> -->
    </div>
    <div class="row g-3 p-3">
      <div class="col-md-5">
        <input id="title" class="form-control" placeholder="Equipment Title" />
      </div>

      <div class="col-md-5">
        <input
          id="imageFile"
          type="file"
          class="form-control"
          accept="image/*"
        />

        <!-- <input id="image" class="form-control" placeholder="Image URL" /> -->
      </div>

      <div class="col-md-2">
        <button
          onclick="createEquipment()"
          class="btn btn-success !rounded-lg w-100"
        >
          Add
        </button>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="bg-card border border-gray-50/20 rounded-2xl shadow-soft4">
    <h5 class="mb-4 font-semibold px-3 pt-3">All Equipment</h5>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>Image</th>
            <th>Title</th>
            <th width="200">Action</th>
          </tr>
        </thead>

        <tbody id="equipmentTable"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ================= MODAL ================= -->

<div class="modal fade" id="editModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Edit Equipment</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input id="editTitle" class="form-control mb-3" placeholder="Title" />
        <input
          id="editImageFile"
          type="file"
          class="form-control"
          accept="image/*"
        />
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button onclick="updateEquipment()" class="btn btn-success">
          Save
        </button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const API_BASE = "/equipment"; // ✅ single source of truth

  let editId = null;
  const modal = new bootstrap.Modal(document.getElementById("editModal"));

  /////////////////////////////////////////////////
  // LOAD ALL
  /////////////////////////////////////////////////
  async function loadEquipment() {
    const res = await fetch(`${API_BASE}/equipment-getall`);
    const data = await res.json();

    const table = document.getElementById("equipmentTable");
    table.innerHTML = "";

    data.forEach((e) => {
      table.innerHTML += `
        <tr>
          <td>
            <img src="${e.image}" width="55" height="55"
              class="rounded shadow-sm object-fit-cover">
          </td>

          <td class="fw-semibold">${e.title}</td>

          <td>
            <button class="btn btn-sm btn-warning me-2"
              onclick="openEdit('${e.id}','${e.title}','${e.image}')">
              Edit
            </button>

            <button class="btn btn-sm btn-danger"
              onclick="deleteEquipment('${e.id}')">
              Delete
            </button>
          </td>
        </tr>
      `;
    });
  }

  /////////////////////////////////////////////////
  // CREATE
  /////////////////////////////////////////////////
  async function createEquipment() {
    const title = document.getElementById("title").value;
    const fileInput = document.getElementById("imageFile");

    if (!title) {
      alert("Enter title");
      return;
    }

    if (!fileInput.files.length) {
      alert("Please select image");
      return;
    }

    const file = fileInput.files[0];

    // 1️⃣ Upload image
    const formData = new FormData();
    formData.append("file", file);
    formData.append("folder", "equipment");

    const uploadRes = await fetch("/upload/file", {
      method: "POST",
      body: formData,
    });

    const uploadData = await uploadRes.json();

    if (!uploadData.success) {
      alert("Image upload failed");
      return;
    }

    // 2️⃣ Save equipment
    await fetch(`${API_BASE}/create-equipment`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title,
        image: uploadData.path,
      }),
    });

    document.getElementById("title").value = "";
    fileInput.value = "";

    loadEquipment();
  }

  /////////////////////////////////////////////////
  // DELETE
  /////////////////////////////////////////////////
  async function deleteEquipment(id) {
    if (!confirm("Delete this equipment?")) return;

    await fetch(`${API_BASE}/equipment-delete/${id}`, {
      method: "DELETE",
    });

    loadEquipment();
  }

  /////////////////////////////////////////////////
  // EDIT
  function openEdit(id, title, image) {
    editId = id;

    document.getElementById("editTitle").value = title;

    // clear old file selection
    document.getElementById("editImageFile").value = "";

    modal.show();
  }

  /////////////////////////////////////////////////
  // UPDATE
  /////////////////////////////////////////////////
  async function updateEquipment() {
    const title = document.getElementById("editTitle").value;
    const fileInput = document.getElementById("editImageFile");

    let imagePath = null;

    ////////////////////////////////////////////
    // If new image selected → upload
    ////////////////////////////////////////////
    if (fileInput.files.length) {
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      formData.append("folder", "equipment");

      const uploadRes = await fetch("/upload/file", {
        method: "POST",
        body: formData,
      });

      const uploadData = await uploadRes.json();

      if (!uploadData.success) {
        alert("Image upload failed");
        return;
      }

      imagePath = uploadData.path;
    }

    ////////////////////////////////////////////
    // Update equipment
    ////////////////////////////////////////////
    await fetch(`${API_BASE}/equipment-update/${editId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title,
        image: imagePath, // null = backend keeps old
      }),
    });

    document.getElementById("editImageFile").value = "";

    modal.hide();
    loadEquipment();
  }

  /////////////////////////////////////////////////

  loadEquipment();
</script>

{% endblock %}
