{% extends "admin/base.html" %} {% block title %}Nurse Details{% endblock %} {%
block content %}

<!-- ================= BASIC INFO ================= -->
<div class="bg-card mb-3 p-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      {% if nurse.profile_photo %}
      <img
        src="https://wecarehhcs.in{{ nurse.profile_photo }}"
        style="width: 90px; height: 90px; border-radius: 50%"
        class="me-3"
      />
      {% endif %}

      <div>
        <h4>{{ user.name }}</h4>
        <h5 class="text-xs">Mobile : {{ user.phone }}</h5>
        <h6 class="text-xs w-full flex">
          Alt Mobile : {{ user.other_number }}
        </h6>

        <!-- <span class="badge bg-warning">{{ nurse.verification_status }}</span> -->

        <span class="mb-1"> {{ nurse.nurse_type }} Nurse </span>
        <div>
          {% if nurse.aadhaar_verified %}
          <span class="badge bg-success">Aadhaar Verified</span>
          {% endif %}
          <span class="badge bg-info"
            >Police Verification {{ nurse.police_verification_status }}</span
          >
          <span
            class="badge {{ 'bg-warning' if nurse.digital_signature_verify else 'bg-danger' }}"
            >Consent : {{ "Signed" if nurse.digital_signature_verify else
            "Unsigned" }}
          </span>
        </div>
      </div>
    </div>

    <!-- üî• NAVIGATION BUTTON -->
    <div>
      {% if nurse.digital_signature %}
      <img
        src="https://wecarehhcs.in{{ nurse.digital_signature }}"
        class="border h-28 w-60 rounded-lg"
      />
      {% endif %}
      <!-- <a
        href="/admin/staff/{{ user.id }}/attendance-salary?month={{ month }}"
        class="btn btn-outline-primary btn-sm"
      >
        üìä Attendance & Salary
      </a> -->
      <!-- <div class="mt-2 flex justify-content-between">
        <h5 class="text-sm">ward : {{ user.ward }}</h5>
        <h5 class="text-sm">room : {{ user.room }}</h5>
      </div> -->
    </div>
  </div>
</div>

<!-- ================= KPI SUMMARY ================= -->
<div class="flex gap-3 mb-3">
  <div class="flex w-full">
    <div
      class="card kpi p-3 text-center flex flex-col align-items-center justify-content-center w-full"
    >
      <small>Attendance ({{ month }})</small>
      <h3>{{ total_present }} Days</h3>
    </div>
  </div>

  <div class="flex w-full">
    <div
      class="card kpi p-3 text-center flex flex-col align-items-center justify-content-center w-full"
    >
      <small>Salary</small>
      <h3>‚Çπ {{ salary.net_salary if salary else "0" }}</h3>
      {% if salary and salary.is_paid %}
      <small class="text-success">Paid</small>
      {% elif salary %}
      <small class="text-danger">Unpaid</small>
      {% endif %}
    </div>
  </div>

  <!-- <div class="col-md-3 flex">
    <div
      class="card kpi p-3 text-center flex flex-col align-items-center justify-content-center w-full"
    >
      <small>Active Duty</small>
      <h3>{{ duty.duty_type if duty else "N/A" }}</h3>
      {% if duty %}
      <small>{{ duty.shift }}</small>
      {% endif %}
    </div>
  </div> -->

  <!-- <div class="col-md-4">
    <div class="card kpi p-3 text-center">
      <small>Consent Status</small>
      <h3>{{ consent.status if consent else "N/A" }}</h3>
      {% if consent %}
      <small>Version {{ consent.version }}</small>
      {% endif %}
    </div>
  </div> -->
</div>

<!-- ================= DOCUMENTS ================= -->
<div class="bg-card mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <h5 class="p-3">Documents</h5>

  <div class="ro flex flex-wrap gap-4 px-3 pb-3">
    <div class="col-md6">
      <!-- <strong>Qualification Documents</strong> -->
      <ul>
        {% for doc in nurse.qualification_docs %}
        <li>
          <a
            href="https://wecarehhcs.in{{ doc }}"
            target="_blank"
            class="border font-semibold border-gray-50 px-3 py-2 mt-2 rounded-lg bg-primary text-white"
            >Qualification</a
          >
        </li>
        {% else %}
        <li class="text-muted">No documents</li>
        {% endfor %}
      </ul>
    </div>

    <div class="col-md6">
      <!-- <strong>Experience Documents</strong> -->
      <ul>
        {% for doc in nurse.experience_docs %}
        <li>
          <a
            href="https://wecarehhcs.in{{ doc }}"
            target="_blank"
            class="border font-semibold border-gray-50 px-3 py-2 mt-2 rounded-lg bg-green-600 text-white"
            >Experience</a
          >
        </li>
        {% else %}
        <li class="text-muted">No documents</li>
        {% endfor %}
      </ul>
    </div>
    <!-- <div class="col-md6">
      
      <ul>
        {% for doc in nurse.qualification_docs %}
        <li>
          <a
            href="https://wecarehhcs.in{{ doc }}"
            target="_blank"
            class="border font-semibold border-gray-50 px-3 py-2 mt-2 rounded-lg bg-orange-500 text-white"
            >Consent Signature</a
          >
        </li>
        {% else %}
        <li class="text-muted">No documents</li>
        {% endfor %}
      </ul>
    </div> -->
    <div class="col-md6">
      <!-- <strong>Qualification Documents</strong> -->
      <ul>
        {% for doc in nurse.police %}
        <li>
          <a
            href="https://wecarehhcs.in{{ doc }}"
            target="_blank"
            class="border font-semibold border-gray-50 px-3 py-2 mt-2 rounded-lg bg-red-500 text-white"
            >Police Verification</a
          >
        </li>
        {% else %}
        <li class="text-muted">No documents</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<!-- ================= LIVE LOCATION TRACKING ================= -->
<div class="bg-card mb-3 p-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0">üìç Live Nurse Location</h5>
    <span id="liveStatus" class="badge bg-secondary"> Checking... </span>
  </div>

  <div class="text-xs text-muted mb-2">
    Last updated: <span id="lastUpdated">-</span>
  </div>

  <div
    id="liveMap"
    style="width: 100%; height: 380px; border-radius: 12px"
  ></div>
</div>
<!-- ================= ATTENDANCE GRAPH ================= -->
<div class="bg-card mb-3 p-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <h5>Attendance Graph ‚Äì {{ month }}</h5>
  <canvas id="attendanceChart" height="120"></canvas>
</div>

<!-- ================= ATTENDANCE TABLE ================= -->
<div class="bg-card mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <h5 class="p-3">Attendance Records ‚Äì {{ month }}</h5>
  <table class="table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Check In</th>
        <th>Check Out</th>
        <th>Method</th>
      </tr>
    </thead>
    <tbody>
      {% for a in attendance %}
      <tr>
        <td>{{ a.date.strftime("%d %b %Y") }}</td>
        <td>{{ a.check_in.strftime("%H:%M") if a.check_in else "-" }}</td>
        <td>{{ a.check_out.strftime("%H:%M") if a.check_out else "-" }}</td>
        <td>{{ a.method }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="4" class="text-muted text-center">
          No attendance for this month
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ================= RECENT VISITS ================= -->
<div class="bg-card mb-3 p-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <h5 class="">Recent Nurse Visits</h5>
  <ul class="activity">
    {% for v in visits %}x
    <li>
      <strong>{{ v.visit_type }}</strong> | Patient ID: {{ v.patient.id }} | {{
      v.visit_time.strftime("%d %b %H:%M") }}
    </li>
    {% else %}
    <li class="text-muted">No visits recorded</li>
    {% endfor %}
  </ul>
</div>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const nurseId = "{{ nurse.id }}";

  // üó∫Ô∏è Init map
  const map = L.map("liveMap").setView([20.5937, 78.9629], 5);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap",
  }).addTo(map);

  let marker = null;

  async function fetchLiveLocation() {
    try {
      const res = await fetch(`/nurse/${nurseId}/location-track`, {
        headers: {
          Authorization: "Bearer " + localStorage.getItem("token"),
        },
      });

      const data = await res.json();

      if (!data.active) {
        setStatus("OFFLINE", false);
        return;
      }

      const lat = data.latitude;
      const lng = data.longitude;

      document.getElementById("lastUpdated").innerText = new Date(
        data.updated_at,
      ).toLocaleTimeString();

      setStatus("LIVE", true);

      if (!marker) {
        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 16);
      } else {
        marker.setLatLng([lat, lng]);
      }
    } catch (e) {
      console.error(e);
      setStatus("ERROR", false);
    }
  }

  function setStatus(text, live) {
    const badge = document.getElementById("liveStatus");
    badge.innerText = text;

    badge.className = "badge " + (live ? "bg-success" : "bg-secondary");
  }

  // üîÅ Poll every 10 sec
  fetchLiveLocation();
  setInterval(fetchLiveLocation, 10000);
</script>

<!-- ================= CHART JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  new Chart(document.getElementById("attendanceChart"), {
    type: "bar",
    data: {
      labels: {{ chart_labels | safe }},
      datasets: [{
        label: "Attendance",
        data: {{ chart_values | safe }},
        borderWidth: 1
      }]
    },
    options: {
      plugins:{ legend:{ display:false }},
      scales:{
        y:{
          beginAtZero:true,
          ticks:{ stepSize:1 }
        }
      }
    }
  });
</script>

{% endblock %}
