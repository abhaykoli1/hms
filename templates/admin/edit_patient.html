
{% extends "admin/base.html" %}
{% block title %}Patient Care{% endblock %}
{% block content %}

<!-- ================= HEADER ================= -->
<div class="bg-card flex flex-col md:flex-row md:items-center md:justify-between gap-4 p-3 mb-4 border border-gray-50/20 rounded-2xl shadow-soft4">
  <div>
    <h4 class="text-md mb-1">Patient Care Management</h4>
    <p class="text-muted text-sm">Admin controls, nurse assignment & security</p>
  </div>

  <!-- PASSWORD UPDATE -->
  <div class="flex items-center gap-2">
    <label>Password:</label>
    <input
      type="text"
      id="password_field"
      class="form-control"
      style="width:220px"
      value="{{ patient.user.password_hash or '' }}"
    />
    <button class="btn btn-success px-3" onclick="updatePassword()">ðŸ’¾</button>
  </div>
</div>

<!-- ================= PATIENT INFO ================= -->
<!-- <div class="bg-card mb-3 p-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="row">
    <div class="col-md-4">
      <p><b>Name:</b> {{ patient.user.name }}</p>
      <p><b>Phone:</b> {{ patient.user.phone }}</p>
      <p><b>Other:</b> {{ patient.user.other_number }}</p>
      <p><b>Email:</b> {{ patient.user.email }}</p>
      <p><b>Address:</b> {{ patient.address }}</p>
    </div>

    <div class="col-md-4">
      <p><b>Age:</b> {{ patient.age }}</p>
      <p><b>Gender:</b> {{ patient.gender }}</p>
      <p><b>Service Start:</b> {{ patient.service_start }}</p>
      <p><b>Service End:</b> {{ patient.service_end or "â€”" }}</p>
    </div>

    <div class="col-md-4">
      <p>
        <b>Assigned Doctor:</b>
        {% if doctor %}
          Dr. {{ doctor.user.name }} ({{ doctor.specialization }})
        {% else %}
          <span class="text-muted">Not Assigned</span>
        {% endif %}
      </p>
    </div>
  </div>
</div> -->

<!-- ================= EDIT PATIENT ================= -->
<div class="bg-card p-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <h5 class="mb-3 font-semibold underline flex gap-2">  <i data-lucide="users" class="w-5 h-5"></i>Edit Patient Details</h5>

  <div class="row g-3">
    <!-- USER -->
    <div class="col-md-4">
      <label>Name</label>
      <input id="edit_name" class="form-control" value="{{ patient.user.name }}">
    </div>

    <div class="col-md-4">
      <label>Phone</label>
      <input id="edit_phone" class="form-control" value="{{ patient.user.phone }}">
    </div>

    <div class="col-md-4">
      <label>Other Number</label>
      <input id="edit_other_number" class="form-control" value="{{ patient.user.other_number or '' }}">
    </div>

    <div class="col-md-4">
      <label>Email</label>
      <input id="edit_email" class="form-control" value="{{ patient.user.email or '' }}">
    </div>

    <!-- PATIENT -->
    <div class="col-md-4">
      <label>Age</label>
      <input id="edit_age" type="number" class="form-control" value="{{ patient.age or '' }}">
    </div>

    <div class="col-md-4">
      <label>Gender</label>
      <select id="edit_gender" class="form-select">
        <option value="">Select</option>
        <option value="Male" {% if patient.gender == "Male" %}selected{% endif %}>Male</option>
        <option value="Female" {% if patient.gender == "Female" %}selected{% endif %}>Female</option>
        <option value="Other" {% if patient.gender == "Other" %}selected{% endif %}>Other</option>
      </select>
    </div>

    <div class="col-md-6">
      <label>Medical History</label>
      <textarea id="edit_medical_history" class="form-control">{{ patient.medical_history }}</textarea>
    </div>

    <div class="col-md-6">
      <label>Address</label>
      <textarea id="edit_address" class="form-control">{{ patient.address }}</textarea>
    </div>

    <div class="col-md-3">
      <label>Service Start</label>
      <input id="edit_service_start" type="date" class="form-control" value="{{ patient.service_start }}">
    </div>

    <div class="col-md-3">
      <label>Service End</label>
      <input id="edit_service_end" type="date" class="form-control" value="{{ patient.service_end }}">
    </div>

  <div class="col-md-3">
    <label>Hospital</label>
    <select id="edit_hospital" class="form-select">
      <option value="">Select</option>

      {% for h in hospitals %}
        <option value="{{ h.id }}"
          {% if patient.user.hospital and patient.user.hospital.id == h.id %}
            selected
          {% endif %}>
          {{ h.name }} ({{ h.branch }})
        </option>
      {% endfor %}
    </select>
  </div>


    <div class="col-md-3">
      <label>Doctor</label>
      <select id="edit_doctor" class="form-select">
        <option value="">Not Assigned</option>
        {% for d in doctors %}
        <option value="{{ d.id }}"
          {% if patient.assigned_doctor and patient.assigned_doctor.id == d.id %}selected{% endif %}>
          {{ d.user.name }} ({{ d.specialization }})
        </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="text- mt-3">
    <button class="- bg-success text-white text-md px-3 py-1.5 hover:scale-105  rounded-xl" onclick="updatePatient()"> Update Patient</button>
  </div>
</div>

<!-- ================= ASSIGN NURSE ================= -->
<!-- ================= ASSIGN NURSE ================= -->
<div class="bg-card mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="card-header font-bold flex gap-2 p-3 bg-light rounded-t-2xl">
    <i data-lucide="stethoscope" class="w-5 h-5 mt-[2px]"></i>
    Assign Nurse
  </div>

  <div class="card-body row g-3 p-3">

    <div class="col-md-4">
      <select id="nurse" class="form-select">
        {% for n in nurses %}
        <option value="{{ n.id }}">
          {{ n.user.name }} ({{ n.nurse_type }})
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <select id="duty_type" class="form-select">
        <option value="10HR">10 Hours</option>
        <option value="12HR">12 Hours</option>
        <option value="24HR">24 Hours</option>
        <option value="FLEX">Flexible</option>
      </select>
    </div>

    <div class="col-md-3">
      <select id="shift" class="form-select">
        <option value="DAY">Day</option>
        <option value="NIGHT">Night</option>
      </select>
    </div>

    <!-- Duty Location -->
    <div class="col-md-3">
      <label>Duty Location</label>
      <select id="dutyLocation" class="form-select" onchange="toggleDutyFields()">
        <option value="HOSPITAL">Hospital</option>
        <option value="HOME">Home</option>
      </select>
    </div>

    <!-- HOSPITAL -->
    <div class="col-md-3 hospital-field">
      <label>Ward</label>
      <input id="ward" class="form-control">
    </div>

    <div class="col-md-3 hospital-field">
      <label>Room</label>
      <input id="room" class="form-control">
    </div>

    <!-- HOME -->
    <div class="col-md-6 home-field d-none">
      <label>Home Address</label>
      <textarea id="address" class="form-control"></textarea>
    </div>

    <!-- Duration -->
    <div class="col-md-3">
      <label>Duration (Days)</label>
      <input type="number" id="duration_days" class="form-control" placeholder="e.g. 5">
    </div>

    <!-- Price Per Day -->
    <div class="col-md-3">
      <label>Price Per Day</label>
      <input type="number" step="0.01" id="price_perday" class="form-control" placeholder="e.g. 1200">
    </div>

    <div class="col-md-2 ">
      <button
        class="bg-success mt-4 text-white px-3 py-2 rounded-xl hover:scale-105"
        id="assignBtn">
        Assign
      </button>
    </div>

  </div>
</div>

<!-- ================= JS ================= -->
<script>
  const patientId = "{{ patient.id }}";

  function headers() {
    return {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.getItem("token"),
    };
  }

  async function updatePatient() {
    const payload = {
      name: edit_name.value,
      phone: edit_phone.value,
      other_number: edit_other_number.value || null,
      email: edit_email.value || null,
      age: edit_age.value || null,
      gender: edit_gender.value || null,
      medical_history: edit_medical_history.value || null,
      address: edit_address.value || null,
      service_start: edit_service_start.value || null,
      service_end: edit_service_end.value || null,
      hospital: edit_hospital.value || null,
      assigned_doctor: edit_doctor.value || null,
    };

    const res = await fetch(`/patient/${patientId}/edit`, {
      method: "PUT",
      headers: headers(),
      body: JSON.stringify(payload),
    });

    const data = await res.json();
    if (!res.ok) return alert(data.detail || "Update failed");

    alert("âœ… Patient updated successfully");
    location.reload();
  }

  document.getElementById("assignBtn").addEventListener("click", async () => {

  const dutyLocation = document.getElementById("dutyLocation").value;
  const duration = parseInt(document.getElementById("duration_days").value) || 0;
const pricePerDay = parseFloat(document.getElementById("price_perday").value) || 0;
 const startDate = new Date();
const endDate = new Date();
endDate.setDate(startDate.getDate() + duration);
  const payload = {
  nurse_id: nurse.value,
  duty_type: duty_type.value,
  shift: shift.value,
  dutyLocation: dutyLocation,

  duration_days: duration,
  price_perday: pricePerDay,

  duty_start: startDate.toISOString(),
  duty_end: endDate.toISOString(),
};
  // ðŸ¥ Hospital
  if (dutyLocation === "HOSPITAL") {
    payload.ward = ward.value || null;
    payload.room_no = room.value || null;
  }

  // ðŸ  Home
  if (dutyLocation === "HOME") {
    payload.address = address.value || null;
  }

  const res = await fetch(`/patient/${patientId}/assign-nurse`, {
    method: "POST",
    headers: headers(),
    body: JSON.stringify(payload),
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.detail || "Failed");
    return;
  }

  alert("âœ… Nurse assigned successfully");
  location.reload();
});

function toggleDutyFields() {
  const location = document.getElementById("dutyLocation").value;

  document.querySelectorAll(".hospital-field").forEach(el =>
    el.classList.toggle("d-none", location === "HOME")
  );

  document.querySelectorAll(".home-field").forEach(el =>
    el.classList.toggle("d-none", location === "HOSPITAL")
  );
}
  async function updatePassword() {
    const res = await fetch("/auth/update-password", {
      method: "POST",
      headers: headers(),
      body: JSON.stringify({
        phone: "{{ patient.user.phone }}",
        password: password_field.value,
      }),
    });

    if (!res.ok) return alert("Failed");
    alert("Password updated");
  }
</script>

{% endblock %}
