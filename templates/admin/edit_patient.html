{% extends "admin/base.html" %} {% block title %}Patient Care{% endblock %} {%
block content %}

<h4 class="mb-3">üßë‚Äç‚öïÔ∏è Patient Care Management</h4>

<!-- ================= PATIENT INFO ================= -->
<div class="bg-card mb-3 p-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="card-body">
    <div class="row">
      <div class="col-md-4">
        <p><b>Name:</b> {{ patient.user.name }}</p>
        <p><b>Phone:</b> {{ patient.user.phone }}</p>
        <p><b>Other number:</b> {{ patient.user.other_number }}</p>
        <p><b>Email:</b> {{ patient.user.email }}</p>
        <p><b>Address:</b> {{ patient.address }}</p>
      </div>

      <div class="col-md-4">
        <p><b>Age:</b> {{ patient.age }}</p>

        <p><b>Gender:</b> {{ patient.gender }}</p>
        <p><b>Service Start:</b> {{ patient.service_start }}</p>
        <p>
          <b>Service End:</b>
          {% if patient.service_end %} {{ patient.service_end }} {% else %} ‚Äî {%
          endif %}
        </p>
      </div>

      <div class="col-md-4">
        <p>
          <b>Assigned Doctor:</b>
          {% if doctor %} Dr. {{ doctor.user.name }} ({{ doctor.specialization
          }}) {% else %}
          <span class="text-muted">Not Assigned</span>
          {% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

<!-- ================= ASSIGN NURSE ================= -->
<div class="bg-card mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="card-header p-3 bg-light !rounded-t-2xl">
    <b>üë©‚Äç‚öïÔ∏è Assign Nurse</b>
  </div>
  <div class="card-body row g-3 p-3">
    <div class="col-md-4">
      <select id="nurse" class="form-select">
        {% for n in nurses %}
        <option value="{{ n.id }}">
          {{ n.user.name }} ({{ n.nurse_type }})
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <select id="duty_type" class="form-select">
        <option value="10HR">10 Hours</option>
        <option value="12HR">12 Hours</option>
        <option value="24HR">24 Hours</option>
      </select>
    </div>

    <div class="col-md-3">
      <select id="shift" class="form-select">
        <option value="DAY">Day</option>
        <option value="NIGHT">Night</option>
      </select>
    </div>

    <div class="col-md-6 mb-3">
      <label>Ward</label>
      <input type="text" class="form-control" id="ward" />
    </div>
    <div class="col-md-6 mb-3">
      <label>Room</label>
      <input type="text" class="form-control" id="room" />
    </div>

    <div class="col-md-2">
      <button class="btn btn-primary w-100" id="assignBtn">Assign</button>
    </div>
  </div>
</div>

<!-- ================= DAILY NOTES ================= -->

<!-- ================= RELATIVES ACCESS ================= -->

<script>
  const patientId = "{{ patient.id }}";

  function headers() {
    return {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.getItem("token"),
    };
  }

  // üîπ Assign Nurse with duty_start and duty_end
  document.getElementById("assignBtn").addEventListener("click", async () => {
    const nurseId = document.getElementById("nurse").value;
    const dutyType = document.getElementById("duty_type").value;
    const shift = document.getElementById("shift").value;

    const now = new Date().toISOString(); // ISO format
    const end = new Date();
    end.setHours(end.getHours() + 12); // Example: duty_end 12 hours later
    const dutyEnd = end.toISOString();

    await fetch(`/patient/${patientId}/assign-nurse`, {
      method: "POST",
      headers: headers(),
      body: JSON.stringify({
        nurse_id: nurseId,
        duty_type: dutyType,
        ward: ward,
        room: room,
        shift: shift,
        duty_start: now,
        duty_end: dutyEnd,
      }),
    });

    alert("Nurse assigned successfully!");
  });

  // üîπ Save Note
  document.getElementById("saveNoteBtn").addEventListener("click", async () => {
    const nurseId = document.getElementById("nurse").value;
    const noteText = document.getElementById("note").value;

    await fetch(`/patient/${patientId}/daily-note`, {
      method: "POST",
      headers: headers(),
      body: JSON.stringify({ nurse_id: nurseId, note: noteText }),
    });

    location.reload();
  });

  // üîπ Save Vitals
  document
    .getElementById("saveVitalsBtn")
    .addEventListener("click", async () => {
      const bp = document.getElementById("bp").value;
      const pulse = document.getElementById("pulse").value;
      const spo2 = document.getElementById("spo2").value;
      const temp = document.getElementById("temp").value;

      await fetch(`/patient/${patientId}/vitals`, {
        method: "POST",
        headers: headers(),
        body: JSON.stringify({ bp, pulse, spo2, temperature: temp }),
      });

      location.reload();
    });
</script>
<script>
  // üîπ Save Medication
  document
    .getElementById("saveMedicationBtn")
    .addEventListener("click", async () => {
      const medicine_name = document.getElementById("medicine_name").value;
      const dosage = document.getElementById("dosage").value;
      const timing = document
        .getElementById("timing")
        .value.split(",")
        .map((t) => t.trim());
      const duration_days = parseInt(
        document.getElementById("duration_days").value,
      );
      const price = parseFloat(document.getElementById("price")?.value || 0.0);

      if (!medicine_name || !dosage || !duration_days || !price) {
        alert("Please fill all required fields");
        return;
      }

      await fetch(`/patient/${patientId}/medication`, {
        method: "POST",
        headers: headers(),
        body: JSON.stringify({
          medicine_name,
          dosage,
          timing,
          duration_days,
          price,
        }),
      });

      location.reload(); // reload page to see new medication
    });
</script>

<script>
  // üîπ Add Relative Access
  document
    .getElementById("addRelativeBtn")
    .addEventListener("click", async () => {
      const relative_user_id = document.getElementById("relative_user").value;
      const access_type = document.getElementById("access_type").value;
      const permissions = Array.from(
        document.getElementById("permissions").selectedOptions,
      ).map((opt) => opt.value);

      if (!relative_user_id) {
        alert("Select a relative");
        return;
      }

      await fetch(`/patient/${patientId}/relative-access`, {
        method: "POST",
        headers: headers(),
        body: JSON.stringify({ relative_user_id, access_type, permissions }),
      });

      location.reload();
    });

  // üîπ Remove Relative Access
  async function removeRelative(accessId) {
    if (!confirm("Are you sure you want to remove this relative's access?"))
      return;

    await fetch(`/patient/${patientId}/relative-access/${accessId}`, {
      method: "DELETE",
      headers: headers(),
    });

    location.reload();
  }
</script>

{% endblock %}
