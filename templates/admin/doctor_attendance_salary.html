{% extends "admin/base.html" %} {% block title %}Doctor Attendance & Salary{%
endblock %} {% block content %}

<!-- ================= BASIC INFO ================= -->
<div class="bg-card p-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <div class="d-flex align-items-center">
    {% if staff.user.profile_photo %}
    <img
      src="/{{ staff.user.profile_photo }}"
      style="width: 90px; height: 90px; border-radius: 50%"
      class="me-3"
    />
    {% endif %}
    <div>
      <h4>Name: {{ staff.user.name }}</h4>
      <h5>Phone: <span class="text-xs"> {{ staff.user.phone }} </span></h5>
      <p class="mb-1">Specialization: {{ staff.specialization }}</p>
      <span class="badge bg-info"
        >Experience: {{ staff.experience_years }} yrs</span
      >
      {% if staff.available %}
      <span class="badge bg-success ms-2">Available</span>
      {% else %}
      <span class="badge bg-danger ms-2">Unavailable</span>
      {% endif %}
    </div>
  </div>
</div>

<!-- ================= KPI SUMMARY ================= -->
<div class="row g-4 mb-4">
  <div class="col-md-4">
    <div class="card kpi">
      <small>Attendance ({{ month }})</small>
      <h3>{{ attendance|length }} Days</h3>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card kpi">
      <small>Salary</small>
      <h3>₹ {{ salary.amount if salary else "N/A" }}</h3>
      {% if salary %} {% if salary.is_paid %}
      <small class="text-success">Paid</small>
      {% else %}
      <small class="text-danger">Unpaid</small>
      {% endif %} {% endif %}
    </div>
  </div>

  <div class="col-md-4">
    <div class="card kpi">
      <small>Joining Date</small>
      <h3>{{ staff.user.created_at.strftime("%d %b %Y") }}</h3>
    </div>
  </div>
</div>

<!-- ================= ATTENDANCE GRAPH ================= -->
<div class="bg-card p-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <h5>Attendance Graph – {{ month }}</h5>
  <canvas id="attendanceChart" height="120"></canvas>
</div>

<!-- ================= ATTENDANCE TABLE ================= -->
<div class="bg-card p-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <h5 class="mb-3">Attendance Records – {{ month }}</h5>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Date</th>
        <th>Check In</th>
        <th>Check Out</th>
        <th>Method</th>
      </tr>
    </thead>
    <tbody>
      {% for a in attendance %}
      <tr>
        <td>{{ a.date.strftime("%d %b %Y") }}</td>
        <td>{{ a.check_in.strftime("%H:%M") if a.check_in else "-" }}</td>
        <td>{{ a.check_out.strftime("%H:%M") if a.check_out else "-" }}</td>
        <td>{{ a.method or "N/A" }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="4" class="text-center text-muted">
          No attendance for this month
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ================= MARK SALARY PAID ================= -->
{% if salary and not salary.is_paid %}
<form method="post" action="/admin/doctor/{{ staff.user.id }}/mark-paid">
  <input type="hidden" name="month" value="{{ month }}" />
  <button type="submit" class="btn btn-success mb-4">Mark Salary Paid</button>
</form>
{% endif %}

<!-- ================= CHART JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  new Chart(document.getElementById("attendanceChart"), {
    type: "bar",
    data: {
      labels: {{ chart_labels|safe }},
      datasets: [{
        label: "Attendance",
        data: {{ chart_values|safe }},
        backgroundColor: "rgba(54, 162, 235, 0.6)",
        borderColor: "rgba(54, 162, 235, 1)",
        borderWidth: 1
      }]
    },
    options: {
      plugins:{ legend:{ display:false }},
      scales:{
        y:{ beginAtZero:true, ticks:{ stepSize:1 } }
      }
    }
  });
</script>

{% endblock %}
