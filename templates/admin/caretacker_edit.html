{% extends "admin/base.html" %}
{% block title %}Manage Nurse{% endblock %}

{% block content %}



<!-- ================= HEADER + PASSWORD ================= -->
<div class="bg-card flex flex-col md:flex-row md:items-center md:justify-between gap-3 
            p-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">

  <!-- Left -->
  <div>
  <h4>Manage Nurse</h4>
  <p class="text-muted">Admin controls & verification</p>

  </div>

  <!-- Right (Password Update) -->
  <div class="flex items-center gap-2 w-full md:w-auto">
<label>Password:</label>

    <input
      type="text"
      id="password_field"
      placeholder="Password"
      class="form-control"
      style="min-width:220px"
      value="{{ nurse.user.password_hash or '' }}"
    />

    <button
      type="button"
      class="border bg-green-700 rounded-lg px-3 py-1.5"
      onclick="updatePassword()"
    >
      üíæ 
    </button>

  </div>
</div>


<form id="nurseForm">

  <!-- ================= VERIFICATION ================= -->
 <div class="bg-card px-3  pt-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">

    <h5 class="text-md font-semibold mb-2 ">Verification</h5>

    <div class="form-check mb-2">
      <input
        class="form-check-input"
        type="checkbox"
        name="aadhaar_verified"
        {{ 'checked' if nurse.aadhaar_verified else '' }}
      />
      <label class="form-check-label ">Aadhaar Verified</label>
    </div>

    <div class="form-check mb-2">
      <input
        class="form-check-input"
        type="checkbox"
        name="digital_signature_verify"
        {{ 'checked' if nurse.digital_signature_verify else '' }}
      />
      <label class="form-check-label ">Signature Verified</label>
    </div>

    <div class="mb-3">
      <label>Police Verification</label>
      <select class="form-select" name="police_verification_status">
        {% for s in ["PENDING","CLEAR","FAILED"] %}
        <option value="{{ s }}"
          {{ 'selected' if nurse.police_verification_status == s else '' }}>
          {{ s }}
        </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- ================= PROFILE ================= -->
 <div class="bg-card px-3  py-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
   <h5 class="text-md font-semibold mb-2 ">Profile</h5>

    <div class="row">

    <div class="col-md-4 mb-3">
  <label>Experience Letter</label>
  <input type="file" id="experienceFile" class="form-control" />
  <div id="experiencePreview" class="mt-2"></div>
</div>

<div class="col-md-4 mb-3">
  <label>Pay Slips</label>
  <input type="file" id="paySlipFile" class="form-control" multiple />
  <div id="paySlipPreview" class="mt-2"></div>
</div>



      <div class="col-md-4 mb-3">
        <label>Nurse Type</label>
        <select class="form-select" name="nurse_type">
          {% for t in ["GNM","ANM","CARETAKER","PHYSIO","COMBO","OTHER"] %}
          <option value="{{ t }}"
            {{ 'selected' if nurse.nurse_type == t else '' }}>
            {{ t }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4 mb-3">
        <label>Joining Date</label>
        <input
          type="date"
          class="form-control"
          name="joining_date"
          value="{{ nurse.joining_date.strftime('%Y-%m-%d') if nurse.joining_date else '' }}"
        />
      </div>

      <div class="col-md-4 mb-3">
        <label>Resignation Date</label>
        <input
          type="date"
          class="form-control"
          name="resignation_date"
          value="{{ nurse.resignation_date.strftime('%Y-%m-%d') if nurse.resignation_date else '' }}"
        />
      </div>
     <div class="col-md-4 mb-3">
      <label>Hospital</label>
      <select class="form-select" name="hospital">
        <option value="">Select Hospital</option>

        {% for h in hospitals %}
          <option value="{{ h.id }}"
            {% if nurse.user and nurse.user.hospital and nurse.user.hospital.id == h.id %}
              selected
            {% endif %}>
            {{ h.name }} ({{ h.branch }})
          </option>
        {% endfor %}
      </select>
</div>

       <div class="col-md-4 mb-3">
       <label>Police Documents</label>
        <input 
          type="file" 
          id="policeFileInput" 
          class="form-control "
          multiple
        />
        <div id="policePreview" class="mt-2"></div>
</div>

{% if nurse.police %}
<div class="mt-2">
  <label>Existing Documents:</label>
  <ul>
    {% for doc in nurse.police %}
      <li>
        <a href="{{ doc }}" target="_blank">View Document</a>
      </li>
    {% endfor %}
  </ul>
</div>
{% endif %}


     <!-- <div class="col-md-4 mb-3">
  <label>Hospital</label>
<select
  class="form-select"
  name="hospital"
  id="hospitalSelect"
>
    <option value="">Select Hospital</option>
  </select>
</div> -->
    </div>
   
    <div class="form-check mt-2">
      <input
        class="form-check-input"
        type="checkbox"
        name="is_active"
        {{ 'checked' if nurse.user and nurse.user.is_active else '' }}
      />
      <label class="form-check-label">Active Nurse</label>
    </div>
  </div>

  <!-- ================= SALARY ================= -->
 <div class="bg-card px-3  pt-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
 <h5 class="text-md font-semibold mb-2 ">Salary & Payment</h5>

    <div class="row">
      <div class="col-md-3 mb-3">
        <label>Salary Type</label>
        <select required class="form-select" name="salary_type">
          {% for t in ["DAILY","MONTHLY"] %}
          <option value="{{ t }}"
            {{ 'selected' if consent and consent.salary_type == t else '' }}>
            {{ t }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3 mb-3">
        <label>Salary Amount</label>
        <input
          type="number"
          step="0.01"
          class="form-control"
          name="salary_amount"
          value="{{ consent.salary_amount if consent else '' }}"
        />
      </div>

      <div class="col-md-3 mb-3">
        <label>Payment Mode</label>
        <select  class="form-select" name="payment_mode">
          {% for p in ["CASH","BANK","UPI"] %}
          <option value="{{ p }}"
            {{ 'selected' if consent and consent.payment_mode == p else '' }}>
            {{ p }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3 mb-3">
        <label>Salary Date</label>
        <input
          type="number"
          min="1"
          max="31"
          class="form-control"
          name="salary_date"
          value="{{ consent.salary_date if consent else '' }}"
          required
        />
      </div>
    </div>
  </div>



  <!-- ================= SUBMIT ================= -->
  <button type="button" class="btn btn-success" id="submitBtn">
    Save Changes
  </button>
  <!-- <a href="/admin/nurses/{{ nurse.id }}" class="btn btn-secondary">Cancel</a> -->
</form>


<!-- ================= VISIT CREATE ================= -->
<div class="bg-card px-3 py-3 mt-4 border border-gray-50/20 rounded-2xl shadow-soft4">

  <h5 class="text-md font-semibold mb-3">‚ûï Create Visit For This Nurse</h5>

  <div class="row g-3">

    <!-- Patient -->
    <div class="col-md-6">
      <label class="form-label">Patient</label>
      <select id="patient_id" class="form-select">
        <option value="">Select Patient</option>
        {% for patient in patients %}
        <option value="{{ patient.id }}">
          {{ patient.user.name }} ({{ patient.user.phone }})
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Visit Type -->
    <div class="col-md-3">
      <label class="form-label">Visit Type</label>
      <select id="visit_type" class="form-select">
        <option value="ROUTINE">ROUTINE</option>
        <option value="MEDICATION">MEDICATION</option>
        <option value="EMERGENCY">EMERGENCY</option>
        <option value="FOLLOW_UP">FOLLOW_UP</option>
        <option value="OTHER">OTHER</option>
      </select>
    </div>

    <!-- Duty Location -->
    <div class="col-md-3">
      <label class="form-label">Duty Location</label>
      <select id="dutyLocation" class="form-select" onchange="toggleLocationFields()">
        <option value="HOSPITAL">Hospital</option>
        <option value="HOME">Home</option>
      </select>
    </div>

    <!-- Hospital Fields -->
    <div class="col-md-3 hospital-field">
      <label class="form-label">Ward</label>
      <input id="ward" class="form-control">
    </div>

    <div class="col-md-3 hospital-field">
      <label class="form-label">Room</label>
      <input id="room_no" class="form-control">
    </div>

    <!-- Home Address -->
    <div class="col-md-6 home-field d-none">
      <label class="form-label">Home Address</label>
      <textarea id="address" class="form-control" rows="2"></textarea>
    </div>

  </div>

  <div class="mt-3">
    <button class="btn btn-success " onclick="createVisit()">
     Create Visit
    </button>
  </div>
</div>


<!-- ================= JS =================
<script>
function headers() {
  return {
    "Authorization": "Bearer " + localStorage.getItem("token")
  };
}

document.addEventListener("DOMContentLoaded", () => {
  

 if (!localStorage.getItem("token")) {
    window.location.href = "/admin/login";
    return;
  }

  const form = document.getElementById("nurseForm");
  const btn = document.getElementById("submitBtn");

  btn.addEventListener("click", async () => {

  const formData = new FormData(form);

  formData.set("aadhaar_verified", form.aadhaar_verified.checked);
  formData.set("digital_signature_verify", form.digital_signature_verify.checked);
  formData.set("is_active", form.is_active.checked);

  // üî• IMPORTANT PART
  uploadedPoliceDocs.forEach(doc => {
    formData.append("police", doc);
  });

  const res = await fetch(`/admin/nurse/{{ nurse.id }}/update`, {
    method: "POST",
     headers: {
    "Authorization": "Bearer " + localStorage.getItem("token")
    },
    body: formData,
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.detail || "‚ùå Update failed");
    return;
  }

  alert("‚úÖ Nurse updated successfully");
  window.location.reload();
});
});
</script>





<script>

  function toggleLocationFields() {
  const location = document.getElementById("dutyLocation").value;

  document.querySelectorAll(".hospital-field").forEach(el => {
    el.classList.toggle("d-none", location === "HOME");
  });

  document.querySelectorAll(".home-field").forEach(el => {
    el.classList.toggle("d-none", location === "HOSPITAL");
  });
}


async function createVisit() {

  const nurseId = "{{ nurse.id }}";

  const dutyLocation = document.getElementById("dutyLocation").value;

  const payload = {
    nurse_id: nurseId,
    patient_id: document.getElementById("patient_id").value,
    visit_type: document.getElementById("visit_type").value,
    dutyLocation: dutyLocation
  };

  if (!payload.patient_id) {
    alert("Select patient");
    return;
  }

  // üè• Hospital
  if (dutyLocation === "HOSPITAL") {
    payload.ward = document.getElementById("ward").value || null;
    payload.room_no = document.getElementById("room_no").value || null;
  }

  // üè† Home
  if (dutyLocation === "HOME") {
    payload.address = document.getElementById("address").value;
    if (!payload.address) {
      alert("Address is required for Home visit");
      return;
    }
  }

  console.log("üì§ Visit Payload:", payload);

  try {
    const res = await fetch(`/nurse/visit/create-admin`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("token")
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) {
      alert(data.detail || "Failed");
      return;
    }

    alert("‚úÖ Visit created successfully");
    location.reload();

  } catch (err) {
    console.error(err);
    alert("Server error");
  }
}

async function updatePassword() {

  const password = document.getElementById("password_field").value;

  if (!password) {
    alert("Password required");
    return;
  }

  const payload = {
    phone: "{{ nurse.user.phone }}",
    password: password
  };

  try {
    const res = await fetch("/auth/update-password", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("token")
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) {
      alert(data.detail || "Failed");
      return;
    }

    alert("‚úÖ Password updated successfully");

  } catch (err) {
    alert("Server error");
  }
}

</script>

<script>

let uploadedPoliceDocs = {{ nurse.police | tojson if nurse.police else "[]" }};

// ================= UPLOAD =================

document.getElementById("policeFileInput")
.addEventListener("change", async function () {

  const files = this.files;

  for (let file of files) {

    const formData = new FormData();
    formData.append("file", file);
    formData.append("folder", "police");

    const res = await fetch("/upload/file", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("token")
      },
      body: formData
    });

    const data = await res.json();

    if (res.ok) {
      uploadedPoliceDocs.push(data.path);
      renderPolicePreview();
    } else {
      alert("Upload failed");
    }
  }
});

// ================= PREVIEW =================

function renderPolicePreview() {
  const preview = document.getElementById("policePreview");
  preview.innerHTML = "";

  uploadedPoliceDocs.forEach((doc, index) => {
    preview.innerHTML += `
      <div class="d-flex justify-content-between align-items-center border p-2 mb-1">
        <a href="${doc}" target="_blank">View</a>
        <button type="button" class="btn btn-sm btn-danger"
          onclick="removePoliceDoc(${index})">
          Remove
        </button>
      </div>
    `;
  });
}

function removePoliceDoc(index) {
  uploadedPoliceDocs.splice(index, 1);
  renderPolicePreview();
}

// First load preview
renderPolicePreview();

let experienceLetterPath = "{{ nurse.experience_letter or '' }}";
let uploadedPaySlips = {{ nurse.paySlip | tojson if nurse.paySlip else "[]" }};
document.getElementById("experienceFile")
.addEventListener("change", async function () {

  const file = this.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);
  formData.append("folder", "experience");

  const res = await fetch("/upload/file", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + localStorage.getItem("token")
    },
    body: formData
  });

  const data = await res.json();

  if (res.ok) {
    experienceLetterPath = data.path;
    renderExperiencePreview();
  } else {
    alert("Upload failed");
  }
});

function renderExperiencePreview() {
  const preview = document.getElementById("experiencePreview");
  preview.innerHTML = experienceLetterPath
    ? `<a href="${experienceLetterPath}" target="_blank">View Experience Letter</a>`
    : "";
}

renderExperiencePreview();
document.getElementById("paySlipFile")
.addEventListener("change", async function () {

  for (let file of this.files) {

    const formData = new FormData();
    formData.append("file", file);
    formData.append("folder", "payslip");

    const res = await fetch("/upload/file", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("token")
      },
      body: formData
    });

    const data = await res.json();

    if (res.ok) {
      uploadedPaySlips.push(data.path);
      renderPaySlipPreview();
    } else {
      alert("Upload failed");
    }
  }
});

function renderPaySlipPreview() {
  const preview = document.getElementById("paySlipPreview");
  preview.innerHTML = "";

  uploadedPaySlips.forEach((doc, index) => {
    preview.innerHTML += `
      <div class="d-flex justify-content-between border p-2 mb-1">
        <a href="${doc}" target="_blank">View</a>
        <button type="button" class="btn btn-sm btn-danger"
          onclick="removePaySlip(${index})">Remove</button>
      </div>
    `;
  });
}

function removePaySlip(index) {
  uploadedPaySlips.splice(index, 1);
  renderPaySlipPreview();
}

renderPaySlipPreview();
document.getElementById("paySlipFile")
.addEventListener("change", async function () {

  for (let file of this.files) {

    const formData = new FormData();
    formData.append("file", file);
    formData.append("folder", "payslip");

    const res = await fetch("/upload/file", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("token")
      },
      body: formData
    });

    const data = await res.json();

    if (res.ok) {
      uploadedPaySlips.push(data.path);
      renderPaySlipPreview();
    } else {
      alert("Upload failed");
    }
  }
});

function renderPaySlipPreview() {
  const preview = document.getElementById("paySlipPreview");
  preview.innerHTML = "";

  uploadedPaySlips.forEach((doc, index) => {
    preview.innerHTML += `
      <div class="d-flex justify-content-between border p-2 mb-1">
        <a href="${doc}" target="_blank">View</a>
        <button type="button" class="btn btn-sm btn-danger"
          onclick="removePaySlip(${index})">Remove</button>
      </div>
    `;
  });
}

function removePaySlip(index) {
  uploadedPaySlips.splice(index, 1);
  renderPaySlipPreview();
}


renderPaySlipPreview();
if (experienceLetterPath) {
  formData.append("experience_letter", experienceLetterPath);
}

uploadedPaySlips.forEach(doc => {
  formData.append("paySlip", doc);
});

uploadedPoliceDocs.forEach(doc => {
  formData.append("police", doc);
});

if (experienceLetterPath) {
  formData.append("experience_letter", experienceLetterPath);
}

uploadedPaySlips.forEach(doc => {
  formData.append("paySlip", doc);
});

</script> -->

<script>
/* =========================================================
   GLOBAL VARIABLES
========================================================= */

let uploadedPoliceDocs = {{ nurse.police | tojson if nurse.police else "[]" }};
let experienceLetterPath = "{{ nurse.experience_letter or '' }}";
let uploadedPaySlips = {{ nurse.paySlip | tojson if nurse.paySlip else "[]" }};


/* =========================================================
   AUTH HEADER
========================================================= */

function headers() {
  return {
    "Authorization": "Bearer " + localStorage.getItem("token")
  };
}


/* =========================================================
   DOM READY
========================================================= */

document.addEventListener("DOMContentLoaded", () => {

  if (!localStorage.getItem("token")) {
    window.location.href = "/admin/login";
    return;
  }

  renderPolicePreview();
  renderExperiencePreview();
  renderPaySlipPreview();

  const form = document.getElementById("nurseForm");
  const btn = document.getElementById("submitBtn");

  btn.addEventListener("click", async () => {

    const formData = new FormData(form);

    formData.set("aadhaar_verified", form.aadhaar_verified.checked);
    formData.set("digital_signature_verify", form.digital_signature_verify.checked);
    formData.set("is_active", form.is_active.checked);

    // ‚úÖ Police
    uploadedPoliceDocs.forEach(doc => {
      formData.append("police", doc);
    });

    // ‚úÖ Experience
    if (experienceLetterPath) {
      formData.append("experience_letter", experienceLetterPath);
    }

    // ‚úÖ PaySlips
    uploadedPaySlips.forEach(doc => {
      formData.append("paySlip", doc);
    });

    const res = await fetch(`/admin/nurse/{{ nurse.id }}/update`, {
      method: "POST",
      headers: headers(),
      body: formData,
    });

    const data = await res.json();

    if (!res.ok) {
      alert(data.detail || "‚ùå Update failed");
      return;
    }

    alert("‚úÖ Nurse updated successfully");
    window.location.reload();
  });

});


/* =========================================================
   POLICE FILE UPLOAD
========================================================= */

document.getElementById("policeFileInput")
.addEventListener("change", async function () {

  for (let file of this.files) {

    const formData = new FormData();
    formData.append("file", file);
    formData.append("folder", "police");

    const res = await fetch("/upload/file", {
      method: "POST",
      headers: headers(),
      body: formData
    });

    const data = await res.json();

    if (res.ok) {
      uploadedPoliceDocs.push(data.path);
      renderPolicePreview();
    } else {
      alert("Police upload failed");
    }
  }
});


function renderPolicePreview() {
  const preview = document.getElementById("policePreview");
  preview.innerHTML = "";

  uploadedPoliceDocs.forEach((doc, index) => {
    preview.innerHTML += `
      <div class="d-flex justify-content-between align-items-center border p-2 mb-1">
        <a href="${doc}" target="_blank">View</a>
        <button type="button" class="btn btn-sm btn-danger"
          onclick="removePoliceDoc(${index})">Remove</button>
      </div>
    `;
  });
}

function removePoliceDoc(index) {
  uploadedPoliceDocs.splice(index, 1);
  renderPolicePreview();
}


/* =========================================================
   EXPERIENCE LETTER UPLOAD
========================================================= */

document.getElementById("experienceFile")
.addEventListener("change", async function () {

  const file = this.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);
  formData.append("folder", "experience");

  const res = await fetch("/upload/file", {
    method: "POST",
    headers: headers(),
    body: formData
  });

  const data = await res.json();

  if (res.ok) {
    experienceLetterPath = data.path;
    renderExperiencePreview();
  } else {
    alert("Experience upload failed");
  }
});


function renderExperiencePreview() {
  const preview = document.getElementById("experiencePreview");
  preview.innerHTML = experienceLetterPath
    ? `<a href="${experienceLetterPath}" target="_blank">View Experience Letter</a>`
    : "";
}


/* =========================================================
   PAY SLIP UPLOAD
========================================================= */

document.getElementById("paySlipFile")
.addEventListener("change", async function () {

  for (let file of this.files) {

    const formData = new FormData();
    formData.append("file", file);
    formData.append("folder", "payslip");

    const res = await fetch("/upload/file", {
      method: "POST",
      headers: headers(),
      body: formData
    });

    const data = await res.json();

    if (res.ok) {
      uploadedPaySlips.push(data.path);
      renderPaySlipPreview();
    } else {
      alert("Payslip upload failed");
    }
  }
});


function renderPaySlipPreview() {
  const preview = document.getElementById("paySlipPreview");
  preview.innerHTML = "";

  uploadedPaySlips.forEach((doc, index) => {
    preview.innerHTML += `
      <div class="d-flex justify-content-between border p-2 mb-1">
        <a href="${doc}" target="_blank">View</a>
        <button type="button" class="btn btn-sm btn-danger"
          onclick="removePaySlip(${index})">Remove</button>
      </div>
    `;
  });
}

function removePaySlip(index) {
  uploadedPaySlips.splice(index, 1);
  renderPaySlipPreview();
}


/* =========================================================
   PASSWORD UPDATE
========================================================= */

async function updatePassword() {

  const password = document.getElementById("password_field").value;

  if (!password) {
    alert("Password required");
    return;
  }

  const res = await fetch("/auth/update-password", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...headers()
    },
    body: JSON.stringify({
      phone: "{{ nurse.user.phone }}",
      password: password
    })
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.detail || "Failed");
    return;
  }

  alert("‚úÖ Password updated successfully");
}


/* =========================================================
   VISIT CREATE
========================================================= */

function toggleLocationFields() {

  const location = document.getElementById("dutyLocation").value;

  document.querySelectorAll(".hospital-field")
    .forEach(el => el.classList.toggle("d-none", location === "HOME"));

  document.querySelectorAll(".home-field")
    .forEach(el => el.classList.toggle("d-none", location === "HOSPITAL"));
}


async function createVisit() {

  const payload = {
    nurse_id: "{{ nurse.id }}",
    patient_id: document.getElementById("patient_id").value,
    visit_type: document.getElementById("visit_type").value,
    dutyLocation: document.getElementById("dutyLocation").value
  };

  if (!payload.patient_id) {
    alert("Select patient");
    return;
  }

  if (payload.dutyLocation === "HOSPITAL") {
    payload.ward = document.getElementById("ward").value || null;
    payload.room_no = document.getElementById("room_no").value || null;
  }

  if (payload.dutyLocation === "HOME") {
    payload.address = document.getElementById("address").value;
    if (!payload.address) {
      alert("Address is required");
      return;
    }
  }

  const res = await fetch(`/nurse/visit/create-admin`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...headers()
    },
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.detail || "Failed");
    return;
  }

  alert("‚úÖ Visit created successfully");
  location.reload();
}

</script>

{% endblock %}
